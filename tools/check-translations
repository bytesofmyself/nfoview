#!/usr/bin/env python

# Check translation files for common errors.
# Usage: check-translations [XX[_YY[@ZZ]]...]

import glob
import os
import sys

args = tuple(sys.argv[1:])
args = tuple("%s.po" % x for x in args)
os.chdir(os.path.join(os.path.dirname(__file__), "..", "po"))
for name in sorted(glob.glob("*.po")):
    if args and not name in args:
        continue
    fobj = open(name, "r", encoding="utf_8")
    lineno = 0
    nbad = 0
    ntotal = 0
    for line in fobj:
        lineno += 1
        line = line.strip()
        if not line.startswith("msgid"):
            continue
        msgid = line[7:-1]
        while True:
            line = fobj.readline().strip()
            lineno += 1
            if line.startswith("msgstr"):
                break
            msgid = "".join((msgid, line[1:-1]))
        if not msgid:
            continue
        if line.startswith("msgstr["):
            # Skip plural forms.
            continue
        lineno_msgstr = lineno
        msgstr = line[8:-1]
        while True:
            line = fobj.readline().strip()
            lineno += 1
            if not line:
                break
            msgstr = "".join((msgstr, line[1:-1]))
        if not msgstr:
            continue
        pos = (name, lineno_msgstr)
        ntotal += 1

        # Check that the translation of a label includes
        # a keyboard accelerator defined by an underscore.
        if "_" in msgid:
            if not "_" in msgstr:
                nbad += 1
                print("{0}:{1:d}: missing accelerator in".format(*pos))
                print('"{0}"'.format(msgid))
                print('"{0}"'.format(msgstr))
                print("")

        # Check that the translation of a label includes
        # a terminating colon.
        if msgid.endswith(":"):
            if not msgstr.endswith(":"):
                nbad += 1
                print("{0}:{1:d}: missing colon in".format(*pos))
                print('"{0}"'.format(msgid))
                print('"{0}"'.format(msgstr))
                print("")

        # Check that the translation of a menu item includes
        # an ellipsis defined by three dots.
        if "..." in msgid:
            if not "..." in msgstr:
                nbad += 1
                print("{0}:{1:d}: missing ellipsis in".format(*pos))
                print('"{0}"'.format(msgid))
                print('"{0}"'.format(msgstr))
                print("")

        # Check that the translation of a menu item includes
        # an ellipsis defined by the Unicode character.
        if "…" in msgid:
            if not "…" in msgstr:
                nbad += 1
                print("{0}:{1:d}: missing ellipsis in".format(*pos))
                print('"{0}"'.format(msgid))
                print('"{0}"'.format(msgstr))
                print("")

    print("{0}: {1:d} bad, {2:d} good messages"
          .format(name, nbad, ntotal - nbad))
